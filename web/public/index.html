<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WASSCE REGISTRATION PAGE</title>
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/loader.css" />
    <script async src="./js/img_capture/opencv.js"></script>
    <script src="./js/img_capture/utils.js"></script>
    <!-- FIXME: Remove this when done and this is still not necessary -->
    <!-- <link rel="stylesheet" href="css/cf_css.css"> -->
  </head>
  <body>
    <header class="main-header">
      <section>
        <h1>WASSCEVERSE.COM</h1>
      </section>
    </header>

    <section id="loader">
      <h1>
        <span class="let1">l</span>
        <span class="let2">o</span>
        <span class="let3">a</span>
        <span class="let4">d</span>
        <span class="let5">i</span>
        <span class="let6">n</span>
        <span class="let7">g</span>
      </h1>
    </section>

    <main id="main">
      <section id="content">
        <header class="content-header">
          <h2>Select your school</h2>
        </header>
        <section id="school_selector">
          <!-- The search bar goes here -->
          <div class="search-bar">
            <p>I am a</p>
            <input type="text" id="search" oninput="inputChange(this)" />
            <p>student</p>
          </div>
          <div class="results">
            <!-- Search result descriptions -->
            <div id="search_desc">
              <span>Schools found: </span>
              <span class="search_data_count">1</span>
            </div>

            <!-- Actual Search results -->
            <div id="search_results">
              <!-- The results appear here from main.js -->
            </div>
          </div>
        </section>
      </section>
    </main>

    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/gh/space10-community/conversational-form@1.0.1/dist/conversational-form.min.js"
      crossorigin
    ></script>

    <script src="https://unpkg.com/pill@1/dist/pill.min.js"></script>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script src="js/pill_code.js"></script>
    <script src="js/main.js"></script>
    <script src="./js/img_capture/utils.js"></script>
    <script src="js/open_main.js"></script>
    <script
      src="./js/img_capture/opencv.js"
      onload="openCvReady();"
    ></script>
    <script src="js/confirmation.js"></script>
  </body>
  <!-- OpenCV Scripts -->
  <script type="text/JavaScript">
            function openCvReady() {
                cv['onRuntimeInitialized']=()=>{
                    let video = document.getElementById("cam_input"); // video is the id of video tag
                    navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                    .then(function(stream) {
                        video.srcObject = stream;
                        video.play();
                    })
                    .catch(function(err) {
                        console.log("An error occurred! " + err);
                    });
                    let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
                    let dst = new cv.Mat(video.height, video.width, cv.CV_8UC1);
                    let gray = new cv.Mat();
                    let cap = new cv.VideoCapture(cam_input);
                    let faces = new cv.RectVector();
                    let classifier = new cv.CascadeClassifier();
                    let utils = new Utils('errorMessage');
                    let faceCascadeFile = 'haarcascade_frontalface_default.xml'; // path to xml
                    utils.createFileFromUrl(faceCascadeFile, faceCascadeFile, () => {
                        classifier.load(faceCascadeFile); // in the callback, load the cascade from file
        });
        const FPS = 24;
        function processVideo() {
            let begin = Date.now();
            cap.read(src);
            src.copyTo(dst)
            cv.cvtColor(dst, gray, cv.COLOR_RGBA2GRAY, 0);
            try{
                classifier.detectMultiScale(gray, faces, 1.1, 3, 0);
                console.log(faces.size());
            }catch(err){
                console.log(err);
            }
            for (let i = 0; i < faces.size(); ++i) {
                let face = faces.get(i);
                let point1 = new cv.Point(face.x, face.y);
                let point2 = new cv.Point(face.x + face.width, face.y + face.height);
                cv.rectangle(dst, point1, point2, [255, 0, 0, 255]);
            }
            cv.imshow("canvas_output", dst);
            // schedule next one.
            let delay = 1000/FPS - (Date.now() - begin);
            setTimeout(processVideo, delay);
        }
        // schedule first one.
        setTimeout(processVideo, 0);
    };
    }
  </script>
</html>
